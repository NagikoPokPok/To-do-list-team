{% extends "base.html" %}

{% block title %}Lỗi máy chủ - {{ app_name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="text-center py-5">
                <!-- 500 Illustration -->
                <div class="mb-4">
                    <svg width="200" height="150" viewBox="0 0 200 150" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- Background -->
                        <rect width="200" height="150" fill="#f8f9fa"/>
                        
                        <!-- 500 Text -->
                        <text x="100" y="80" text-anchor="middle" font-family="Arial, sans-serif" font-size="48" font-weight="bold" fill="#dc3545">500</text>
                        
                        <!-- Server icon -->
                        <g transform="translate(75, 30)">
                            <rect x="0" y="0" width="50" height="30" rx="3" fill="none" stroke="#6c757d" stroke-width="2"/>
                            <rect x="5" y="5" width="40" height="4" fill="#6c757d"/>
                            <rect x="5" y="12" width="40" height="4" fill="#6c757d"/>
                            <rect x="5" y="19" width="40" height="4" fill="#6c757d"/>
                            <circle cx="40" cy="7" r="2" fill="#dc3545"/>
                            <circle cx="40" cy="14" r="2" fill="#dc3545"/>
                            <circle cx="40" cy="21" r="2" fill="#dc3545"/>
                        </g>
                        
                        <!-- Warning symbol -->
                        <g transform="translate(140, 110)">
                            <polygon points="15,5 25,25 5,25" fill="#ffc107" stroke="#f0ad4e" stroke-width="2"/>
                            <text x="15" y="20" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#856404">!</text>
                        </g>
                        
                        <!-- Smoke/Error lines -->
                        <g stroke="#dc3545" stroke-width="2" opacity="0.7">
                            <path d="M85 20 Q90 15 95 20 Q100 25 105 20 Q110 15 115 20" fill="none">
                                <animate attributeName="d" 
                                         values="M85 20 Q90 15 95 20 Q100 25 105 20 Q110 15 115 20;
                                                 M85 18 Q90 13 95 18 Q100 23 105 18 Q110 13 115 18;
                                                 M85 20 Q90 15 95 20 Q100 25 105 20 Q110 15 115 20"
                                         dur="2s" repeatCount="indefinite"/>
                            </path>
                            <path d="M88 25 Q93 20 98 25 Q103 30 108 25" fill="none">
                                <animate attributeName="d" 
                                         values="M88 25 Q93 20 98 25 Q103 30 108 25;
                                                 M88 23 Q93 18 98 23 Q103 28 108 23;
                                                 M88 25 Q93 20 98 25 Q103 30 108 25"
                                         dur="2.5s" repeatCount="indefinite"/>
                            </path>
                        </g>
                    </svg>
                </div>

                <h1 class="display-4 text-danger mb-3">Lỗi máy chủ!</h1>
                <h2 class="h4 text-muted mb-4">Đã xảy ra sự cố</h2>
                
                <p class="lead text-muted mb-4">
                    Xin lỗi, máy chủ đang gặp sự cố tạm thời. 
                    Chúng tôi đã được thông báo và đang khắc phục vấn đề này.
                </p>

                <!-- Error Details (if available) -->
                {% if error_details %}
                <div class="alert alert-danger" role="alert">
                    <h6 class="alert-heading">
                        <i class="fas fa-exclamation-triangle me-2"></i>Chi tiết lỗi:
                    </h6>
                    <p class="mb-0">{{ error_details }}</p>
                </div>
                {% endif %}

                <!-- Quick Actions -->
                <div class="d-flex flex-column flex-sm-row gap-3 justify-content-center mb-4">
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-refresh me-2"></i>Thử lại
                    </button>
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="fas fa-home me-2"></i>Về trang chủ
                    </a>
                    <button class="btn btn-outline-info" onclick="history.back()">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </button>
                </div>

                <!-- Status Information -->
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-info-circle text-info me-2"></i>Thông tin trạng thái
                        </h6>
                        <div class="row text-start">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <strong>Thời gian:</strong><br>
                                    <span id="errorTime">{{ error_time or "Vừa xong" }}</span>
                                </small>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <strong>Mã lỗi:</strong><br>
                                    <span id="errorId">{{ error_id or "ERR_500_" + range(1000, 9999) | random | string }}</span>
                                </small>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                                     role="progressbar" style="width: 100%"></div>
                            </div>
                            <small class="text-muted">Đang khắc phục sự cố...</small>
                        </div>
                    </div>
                </div>

                <!-- What you can do -->
                <div class="mt-4">
                    <h6 class="text-muted mb-3">Trong khi chờ đợi, bạn có thể:</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock text-primary me-3"></i>
                                <small class="text-muted">Chờ vài phút và thử lại</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-sync text-info me-3"></i>
                                <small class="text-muted">Kiểm tra kết nối mạng</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-history text-success me-3"></i>
                                <small class="text-muted">Xem lại trang trước đó</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-envelope text-warning me-3"></i>
                                <small class="text-muted">Liên hệ hỗ trợ kỹ thuật</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Support -->
                <div class="mt-5 pt-4 border-top">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Liên hệ hỗ trợ</h6>
                            <p class="text-muted small">
                                <i class="fas fa-envelope me-2"></i>
                                <a href="mailto:support@todoapp.com" class="text-decoration-none">
                                    support@todoapp.com
                                </a>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Trạng thái hệ thống</h6>
                            <p class="text-muted small">
                                <i class="fas fa-external-link-alt me-2"></i>
                                <a href="/status" class="text-decoration-none">
                                    Kiểm tra trạng thái
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional CSS for animations -->
<style>
.display-4 {
    animation: shake 0.8s ease-out;
}

.lead {
    animation: fadeInUp 0.8s ease-out;
}

.btn {
    animation: fadeInUp 1s ease-out;
}

@keyframes shake {
    0%, 100% {
        transform: translateX(0);
    }
    25% {
        transform: translateX(-5px);
    }
    75% {
        transform: translateX(5px);
    }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card {
    animation: fadeIn 1.2s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* Pulse effect for error text */
.text-danger {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.7;
    }
}

/* Server icon animation */
svg g[transform*="translate(75, 30)"] circle {
    animation: blink 1s infinite alternate;
}

@keyframes blink {
    from {
        opacity: 1;
    }
    to {
        opacity: 0.3;
    }
}

/* Hover effects */
.btn:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Auto-retry functionality
let retryCount = 0;
const maxRetries = 3;

function autoRetry() {
    if (retryCount < maxRetries) {
        retryCount++;
        setTimeout(() => {
            console.log(`Auto retry attempt ${retryCount}/${maxRetries}`);
            location.reload();
        }, 5000 * retryCount); // Exponential backoff
    }
}

// Start auto-retry after 10 seconds
setTimeout(autoRetry, 10000);

// Update error time display
document.addEventListener('DOMContentLoaded', function() {
    const errorTimeElement = document.getElementById('errorTime');
    if (errorTimeElement && !errorTimeElement.textContent.trim()) {
        errorTimeElement.textContent = new Date().toLocaleString('vi-VN');
    }
});

// Track 500 errors for analytics (if needed)
if (typeof gtag !== 'undefined') {
    gtag('event', 'server_error', {
        'error_code': '500',
        'page_location': window.location.href,
        'page_title': '500 - Server Error'
    });
}

// Report error to monitoring service (if configured)
if (typeof reportError === 'function') {
    reportError({
        type: 'server_error',
        code: 500,
        url: window.location.href,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent
    });
}

// Countdown timer for auto-retry
function showRetryCountdown() {
    const retryButton = document.querySelector('.btn-primary');
    let countdown = 30;
    
    const interval = setInterval(() => {
        if (countdown > 0) {
            retryButton.innerHTML = `<i class="fas fa-refresh me-2"></i>Thử lại (${countdown}s)`;
            countdown--;
        } else {
            clearInterval(interval);
            retryButton.innerHTML = '<i class="fas fa-refresh me-2"></i>Thử lại';
            location.reload();
        }
    }, 1000);
}

// Start countdown after initial delay
setTimeout(showRetryCountdown, 5000);
</script>
{% endblock %}